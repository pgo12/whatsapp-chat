<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp-Style Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .notification {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin: 5px;
            font-size: 14px;
            text-align: center;
        }

        .meta {
            font-size: 10px;
        }

        .image-message {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 5px;
        }
    </style>
</head>

<body class="flex justify-center items-center min-h-screen bg-[#e5ddd5] font-sans">
    <div id="chat-container" class="w-96 h-[600px] bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
        <h1 class="bg-[#075e54] text-white py-2 text-center text-lg font-normal">WhatsApp Chat</h1>
        <div id="typing-indicator" class="px-2 text-sm italic text-gray-500 h-5 bg-gray-200 border-b border-gray-300">
        </div>
        <div id="user-list" class="w-full bg-gray-100 p-2 border-b border-gray-200 max-h-36 overflow-y-auto flex wrap">
        </div>
        <div id="messages" class="flex-1 p-2 overflow-y-auto bg-gray-200 flex flex-col"></div>

        <div id="private-chat" class="hidden flex-col h-1/2">
            <h2 id="private-chat-header"
                class="relative bg-[#075e54] text-white py-2 px-4 text-center flex items-center justify-center border-b border-gray-300">
                Private Chat
            </h2>
            <div id="private-messages" class="flex-1 p-2 overflow-y-auto bg-gray-200 flex flex-col"></div>
            <div id="private-input-container" class="flex p-2 bg-gray-100 border-t border-gray-200">
                <input id="private-message" placeholder="Type a private message..."
                    class="flex-1 p-2 border border-gray-300 rounded-full mr-2 text-sm outline-none">
                <button id="private-sendBtn"
                    class="px-4 py-2 bg-[#075e54] text-white rounded-full hover:bg-[#128c7e] focus:outline-none">Send</button>
            </div>
        </div>

        <div id="input-container" class="flex p-2 bg-gray-100 border-t border-gray-200">
            <input id="message" placeholder="Type a message..."
                class="flex-1 p-2 border border-gray-300 rounded-full mr-2 text-sm outline-none">
            <input type="file" id="image-upload" class="hidden" accept="image/*">
            <button id="imageBtn" class="px-2 text-sm text-gray-600 hover:text-gray-800">ðŸ“·</button>
            <button id="sendBtn"
                class="px-4 py-2 bg-[#075e54] text-white rounded-full hover:bg-[#128c7e] focus:outline-none">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const messages = document.getElementById("messages");
        const messageInput = document.getElementById("message");
        const sendBtn = document.getElementById("sendBtn");
        const userList = document.getElementById("user-list");
        const typingIndicator = document.getElementById("typing-indicator");

        const imageBtn = document.getElementById("imageBtn");
        const imageUpload = document.getElementById("image-upload");

        const privateChat = document.getElementById("private-chat");
        const privateMessages = document.getElementById("private-messages");
        const privateMessageInput = document.getElementById("private-message");
        const privateSendBtn = document.getElementById("private-sendBtn");

        let username;
        let privateChatUser;

        while (!username) {
            username = prompt("Please enter your username:");
        }

        socket.emit("new-user", username);

        socket.on("message", (message) => {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");

            const isSentByUser = message.username === username; // Check if the message is sent by the current user

            // Create the meta element for message metadata
            const meta = document.createElement("span");
            meta.classList.add("meta");
            meta.innerText = `${message.username} â€¢ ${message.timestamp}`;

            // Handle notification messages
            if (message.type === "notification") {
                messageDiv.innerText = message.text;
                messageDiv.style.textAlign = "center";
                messageDiv.style.fontStyle = "italic";
                messageDiv.style.color = "gray";
            }
            // Handle image messages
            else if (message.type === "image") {
                const img = document.createElement("img");
                img.src = message.image;
                img.classList.add("image-message");

                const downloadLink = document.createElement("a");
                downloadLink.href = message.image;
                downloadLink.download = `image_${message.timestamp}.png`;
                downloadLink.appendChild(img);

                const p = document.createElement("p");
                p.appendChild(downloadLink);

                // Apply classes based on message sender
                const classesToAdd = isSentByUser ?
                    ["bg-[#dcf8c6]", "self-end", "rounded-tl-lg", "max-w-[70%]", "ml-auto"] :
                    ["bg-white", "self-start", "rounded-tr-lg", "shadow-sm", "max-w-[70%]"];

                messageDiv.classList.add(...classesToAdd, "m-2", "p-2", "rounded-lg", "text-sm");

                // Create and append the unsend button only for the user
                if (isSentByUser) {
                    const unsendBtn = document.createElement("button");
                    unsendBtn.innerText = "Unsend";
                    unsendBtn.className = "text-red-500 text-xs ml-2 cursor-pointer";
                    unsendBtn.onclick = () => {
                        socket.emit("unsend-message", { timestamp: message.timestamp, type: "image" });
                        messageDiv.remove(); // Remove from the UI
                    };
                    p.appendChild(unsendBtn);
                }

                messageDiv.appendChild(p);
                messageDiv.appendChild(meta);
            }
            // Handle text messages
            else {
                const p = document.createElement("p");
                p.innerText = message.text;

                // Apply classes based on message sender
                const classesToAdd = isSentByUser ?
                    ["bg-[#dcf8c6]", "self-end", "rounded-tl-lg"] :
                    ["bg-white", "self-start", "rounded-tr-lg", "shadow-sm"];

                messageDiv.classList.add(...classesToAdd, "m-2", "p-2", "rounded-lg", "max-w-[80%]", "text-sm", "relative", "word-break");

                // Create and append the unsend button only for the user
                if (isSentByUser) {
                    const unsendBtn = document.createElement("button");
                    unsendBtn.innerText = "Unsend";
                    unsendBtn.className = "text-red-500 text-xs ml-2 cursor-pointer";
                    unsendBtn.onclick = () => {
                        socket.emit("unsend-message", { timestamp: message.timestamp, type: "text" });
                        messageDiv.remove(); // Remove from the UI
                    };
                    p.appendChild(unsendBtn);
                }

                messageDiv.appendChild(p);
                messageDiv.appendChild(meta);
            }

            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        });


        socket.on("remove-message", (timestamp) => {
            const allMessages = document.querySelectorAll('.message');
            allMessages.forEach(msg => {
                const meta = msg.querySelector('.meta');
                if (meta && meta.innerText.includes(timestamp)) {
                    msg.remove();
                }
            });
        });

        // Send message
        sendBtn.addEventListener("click", () => {
            const text = messageInput.value;
            if (text) {
                const messageData = { text: text, type: "user-message" };
                socket.emit("user-message", messageData);
                messageInput.value = "";
            }
        });

        messageInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                sendBtn.click();
            }
        });

        // Handle private messaging
        socket.on("private-message", (message) => {
            if (privateChatUser && privateChatUser.username === message.username) {
                appendPrivateMessage(message);
            } else {
                if (!unreadMessages[message.username]) {
                    unreadMessages[message.username] = [];
                }
                unreadMessages[message.username].push(message);

                showNotification(message.username);
            }
        });

        function appendPrivateMessage(message) {
            const messageDiv = document.createElement("div");
            const p = document.createElement("p");
            const meta = document.createElement("span");

            p.innerText = message.text;
            meta.classList.add("text-xs", "text-gray-500", "text-right", "mt-1");
            meta.innerText = `${message.username} â€¢ ${message.timestamp}`;

            const isSentByUser = message.username === username;

            const sentClasses = ["bg-[#dcf8c6]", "self-end", "rounded-tl-lg", "max-w-[70%]", "ml-auto"];
            const receivedClasses = ["bg-white", "self-start", "rounded-tr-lg", "shadow-sm", "max-w-[70%]"];

            const classesToAdd = isSentByUser ? sentClasses : receivedClasses;
            messageDiv.classList.add(...classesToAdd, "m-2", "p-2", "rounded-lg", "text-sm");

            messageDiv.appendChild(p);
            messageDiv.appendChild(meta);
            privateMessages.appendChild(messageDiv);
            privateMessages.scrollTop = privateMessages.scrollHeight;
        }

        privateMessageInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                privateSendBtn.click();
            }
        });

        function showNotification(username) {
            const userDiv = Array.from(userList.children).find(
                (div) => div.innerText === username
            );
            if (userDiv) {
                if (!userDiv.querySelector(".badge")) {
                    const badge = document.createElement("span");
                    badge.className = "badge bg-red-500 text-white rounded-full px-2 ml-2";
                    badge.innerText = unreadMessages[username].length;
                    userDiv.appendChild(badge);
                } else {
                    const badge = userDiv.querySelector(".badge");
                    badge.innerText = unreadMessages[username].length;
                }
            }
        }

        function openPrivateChat(user) {
            if (privateChat.style.display === "flex" && privateChatUser?.username === user.username) {
                privateChat.style.display = "none";
            } else {
                privateChat.style.display = "flex";

                if (!privateChatUser || privateChatUser.username !== user.username) {
                    privateChatUser = user;
                    document.getElementById("private-chat-header").innerText = `Chat with ${user.username}`;

                    if (unreadMessages[user.username]) {
                        unreadMessages[user.username].forEach((msg) => appendPrivateMessage(msg));
                        unreadMessages[user.username] = [];
                        removeNotificationBadge(user.username);
                    }
                }
            }
        }


        function removeNotificationBadge(username) {
            const userDiv = Array.from(userList.children).find((div) =>
                div.innerText.trim().startsWith(username)
            );

            if (userDiv) {
                const badge = userDiv.querySelector(".badge");
                if (badge) {
                    badge.remove();
                }
            }
        }

        // Send private message
        privateSendBtn.addEventListener("click", () => {
            const text = privateMessageInput.value;
            if (privateChatUser && text) {
                socket.emit("private-message", {
                    text: text,
                    to: privateChatUser.socketId,
                    username: username
                });

                const message = {
                    text: text,
                    username: username,
                    timestamp: new Date().toLocaleTimeString(),
                };

                appendPrivateMessage(message);

                privateMessageInput.value = "";
            }
        });

        imageBtn.addEventListener("click", () => {
            imageUpload.click();
        });

        imageUpload.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Image = reader.result;
                    socket.emit("user-message", { image: base64Image, type: "image" });
                };
                reader.readAsDataURL(file);
                event.target.value = "";
            }
        });

        // Typing indicator
        messageInput.addEventListener("input", () => {
            if (messageInput.value) {
                socket.emit("typing", username);
            } else {
                socket.emit("stop-typing");
            }
        });

        socket.on("typing", (data) => {
            typingIndicator.innerText = `${data} is typing...`;
        });

        socket.on("stop-typing", () => {
            typingIndicator.innerText = "";
        });

        document.addEventListener("click", (event) => {
            const isInputClicked = messageInput.contains(event.target) || privateMessageInput.contains(event.target);
            const isChatContainerClicked = document.getElementById("chat-container").contains(event.target);

            if (!isInputClicked && !isChatContainerClicked) {
                typingIndicator.innerText = "";
                socket.emit("stop-typing");
            }
        });

        // Update user list
        socket.on("user-list", (users) => {
            userList.innerHTML = "";
            users.forEach((user) => {
                const userDiv = document.createElement("div");
                userDiv.classList.add(
                    "user",
                    "px-2",
                    "hover:bg-gray-300",
                    "cursor-pointer",
                    "inline-flex",
                    "items-center",
                    "rounded-md",
                    "bg-gray-50",
                    "text-xs",
                    "font-medium",
                    "text-gray-600",
                    "ring-1",
                    "ring-inset",
                    "ring-gray-500/10"
                );

                userDiv.innerText = user.username;
                userDiv.addEventListener("click", () => {
                    openPrivateChat(user);
                });
                userList.appendChild(userDiv);
            });
        });

        // User join/leave notifications
        socket.on("user-joined", (username) => {
            const notificationDiv = document.createElement("div");
            notificationDiv.classList.add("notification");
            notificationDiv.innerText = `${username} has joined the chat.`;
            messages.appendChild(notificationDiv);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on("user-left", (username) => {
            const notificationDiv = document.createElement("div");
            notificationDiv.classList.add("notification");
            notificationDiv.innerText = `${username} has left the chat.`;
            messages.appendChild(notificationDiv);
            messages.scrollTop = messages.scrollHeight;
        });


    </script>
</body>

</html>